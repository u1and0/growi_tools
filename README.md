# 完成品イメージ

## 完成品スクショ

![Screenshot from 2022-06-19 23-28-07.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/113494/b14b766c-b28b-8f58-58f9-7867834188f6.png)

## 完成品標準出力

<details><summary>完成品標準出力</summary>

```markdown
# :heart:ライクが多いランキングトップ10

1. :arrow_right: [/お試し](https://demo.growi.org/5ee0e945ac9357004883964d) :heart:2 :footprints:17 :speech_balloon:0 :pencil2:2
2. :arrow_right: [/お試し/改善](https://demo.growi.org/5f0d697a7cec480048dba270) :heart:2 :footprints:6 :speech_balloon:1 :pencil2:1
3. :arrow_upper_right: [/お試し1/はじめてのページ777](https://demo.growi.org/62b03e339f17db565044b295) :heart:1 :footprints:1 :speech_balloon:1 :pencil2:1
4. :arrow_upper_right: [/お試し/Ranking](https://demo.growi.org/62acf2940b8a39f163ef243d) :heart:1 :footprints:1 :speech_balloon:0 :pencil2:1
5. :arrow_upper_right: [/お試し/はじめてのページ/入れ子のページ](https://demo.growi.org/6281d16d6fa435d7f5925b6c) :heart:1 :footprints:3 :speech_balloon:0 :pencil2:1
6. :arrow_upper_right: [/お試し/はじめてのページkeeeeeeesuke99/入れ子ページ](https://demo.growi.org/6138b7cc285c8c000c142683) :heart:1 :footprints:3 :speech_balloon:0 :pencil2:1
7. :arrow_upper_right: [/お試し/はじめてのページ8](https://demo.growi.org/60a37ca862e1c30049ddf60b) :heart:1 :footprints:3 :speech_balloon:1 :pencil2:1
8. :arrow_upper_right: [/お試し/はじめてのページ10](https://demo.growi.org/607d9616e73c630049b23776) :heart:1 :footprints:4 :speech_balloon:0 :pencil2:1
9. :arrow_upper_right: [/お試し/はじめてのページぽい/入れ子のページぽい](https://demo.growi.org/607547fa4101e20049da2993) :heart:1 :footprints:2 :speech_balloon:0 :pencil2:1
10. :new: [/お試し/はじめてのページ3](https://demo.growi.org/5fca12dbc5c66700485f1ed4) :heart:1 :footprints:3 :speech_balloon:0 :pencil2:1

# :footprints:足跡が多いランキングトップ10

1. :arrow_right: [/お試し](https://demo.growi.org/5ee0e945ac9357004883964d) :heart:2 :footprints:17 :speech_balloon:0 :pencil2:2
2. :arrow_right: [/お試しです/はじめてのページ](https://demo.growi.org/5db14ee94dc19b0044efe9ea) :heart:0 :footprints:11 :speech_balloon:0 :pencil2:1
3. :arrow_right: [/お試し/改善](https://demo.growi.org/5f0d697a7cec480048dba270) :heart:2 :footprints:6 :speech_balloon:1 :pencil2:1
4. :arrow_right: [/お試しです/はじめてのページ/入れ子のページ](https://demo.growi.org/5db1507c4dc19b0044efe9ef) :heart:0 :footprints:6 :speech_balloon:0 :pencil2:1
5. :arrow_right: [/お試しa/はじめてのページ/おりたたみ](https://demo.growi.org/62148d1287b16dd2e145e757) :heart:0 :footprints:5 :speech_balloon:0 :pencil2:1
6. :arrow_right: [/お試しa/はじめてのページ/入れ子のページ](https://demo.growi.org/62148abc87b16dd2e145e04f) :heart:0 :footprints:5 :speech_balloon:0 :pencil2:1
7. :arrow_right: [/お試し/改善/タグの関係_blockdiag](https://demo.growi.org/5f0e826405904e00485a210a) :heart:0 :footprints:5 :speech_balloon:0 :pencil2:1
8. :arrow_right: [/お試し/改善/入れ子のページ](https://demo.growi.org/5f0d69c87cec480048dba273) :heart:0 :footprints:5 :speech_balloon:0 :pencil2:1
9. :arrow_right: [/お試し/はじめてのページ10](https://demo.growi.org/607d9616e73c630049b23776) :heart:1 :footprints:4 :speech_balloon:0 :pencil2:1
10. :arrow_right: [/お試しです](https://demo.growi.org/5c6b517016763b003f629b9f) :heart:0 :footprints:4 :speech_balloon:0 :pencil2:2

# :speech_balloon:コメントが多いランキングトップ10

1. :arrow_right: [/お試し/改善](https://demo.growi.org/5f0d697a7cec480048dba270) :heart:2 :footprints:6 :speech_balloon:1 :pencil2:1
2. :arrow_right: [/お試し/改善/タグの関係_draw.io](https://demo.growi.org/5f0d6deb7cec480048dba27f) :heart:0 :footprints:4 :speech_balloon:1 :pencil2:1
3. :arrow_right: [/お試し/はじめてのページ8](https://demo.growi.org/60a37ca862e1c30049ddf60b) :heart:1 :footprints:3 :speech_balloon:1 :pencil2:1
4. :arrow_right: [/お試し2/はじめてのページ](https://demo.growi.org/5e2ced5688ba150043d9b4e1) :heart:0 :footprints:3 :speech_balloon:1 :pencil2:1
5. :arrow_right: [/お試し/改善/A1](https://demo.growi.org/5f0d6cea7cec480048dba279) :heart:0 :footprints:2 :speech_balloon:1 :pencil2:1
6. :arrow_right: [/お試しです/初めてのページ/入れ子のページ](https://demo.growi.org/5e0421bf88ba150043d9b35b) :heart:0 :footprints:2 :speech_balloon:1 :pencil2:1
7. :arrow_upper_right: [/お試し1/はじめてのページ777](https://demo.growi.org/62b03e339f17db565044b295) :heart:1 :footprints:1 :speech_balloon:1 :pencil2:1
8. :arrow_upper_right: [/お試し](https://demo.growi.org/5ee0e945ac9357004883964d) :heart:2 :footprints:17 :speech_balloon:0 :pencil2:2
9. :arrow_upper_right: [/お試しです/はじめてのページ](https://demo.growi.org/5db14ee94dc19b0044efe9ea) :heart:0 :footprints:11 :speech_balloon:0 :pencil2:1
10. :new: [/お試しです/はじめてのページ/入れ子のページ](https://demo.growi.org/5db1507c4dc19b0044efe9ef) :heart:0 :footprints:6 :speech_balloon:0 :pencil2:1

# :pencil2:編集者が多いランキングトップ10

1. :arrow_right: [/お試し](https://demo.growi.org/5ee0e945ac9357004883964d) :heart:2 :footprints:17 :speech_balloon:0 :pencil2:2
2. :arrow_right: [/お試しです](https://demo.growi.org/5c6b517016763b003f629b9f) :heart:0 :footprints:4 :speech_balloon:0 :pencil2:2
3. :arrow_right: [/お試し/改善](https://demo.growi.org/5f0d697a7cec480048dba270) :heart:2 :footprints:6 :speech_balloon:1 :pencil2:1
4. :arrow_right: [/お試し/改善/タグの関係_draw.io](https://demo.growi.org/5f0d6deb7cec480048dba27f) :heart:0 :footprints:4 :speech_balloon:1 :pencil2:1
5. :arrow_right: [/お試し/はじめてのページ8](https://demo.growi.org/60a37ca862e1c30049ddf60b) :heart:1 :footprints:3 :speech_balloon:1 :pencil2:1
6. :arrow_right: [/お試し2/はじめてのページ](https://demo.growi.org/5e2ced5688ba150043d9b4e1) :heart:0 :footprints:3 :speech_balloon:1 :pencil2:1
7. :arrow_right: [/お試し/改善/A1](https://demo.growi.org/5f0d6cea7cec480048dba279) :heart:0 :footprints:2 :speech_balloon:1 :pencil2:1
8. :arrow_right: [/お試しです/初めてのページ/入れ子のページ](https://demo.growi.org/5e0421bf88ba150043d9b35b) :heart:0 :footprints:2 :speech_balloon:1 :pencil2:1
9. :arrow_upper_right: [/お試し1/はじめてのページ777](https://demo.growi.org/62b03e339f17db565044b295) :heart:1 :footprints:1 :speech_balloon:1 :pencil2:1
10. :new: [/お試しです/はじめてのページ](https://demo.growi.org/5db14ee94dc19b0044efe9ea) :heart:0 :footprints:11 :speech_balloon:0 :pencil2:1
```

</details>

# 前準備
環境変数にGrowiのURLとアクセストークンを指定する必要があります。
URLはデフォルトで`http://localhost:3000`が指定されますので、
ローカルで動いているGrowiに対しては指定の必要がありません。

アクセストークンは必須です。

試しに [Growiのデモページ](https://demo.growi.org/5c9403b8ef06c40058a243e8) にアカウントを作って試した結果が上のスクショです。

"/"ルートからランキングを作るとページ数が5800以上と多くて1分程時間がかかりましたが、"お試し"ページが80ページほどでちょうどよかったので、[ "/お試し/Ranking" ](https://demo.growi.org/62acf2940b8a39f163ef243d)にランキングを作成してみました。 10秒ほどで作成できます。


# 要素定義

```python
fields = {
    "path": "",
    "id": "",
    "liker": 0,
    "seen": 0,
    "commentCount": 0,
    "authors": 0
}
Rank = namedtuple("Rank", fields.keys(), defaults=fields.values())
```

ランキングの一要素を表現する `Rank` タプルです。
`namedtuple` を使っているので、ドットプロパティメソッドが使えます。
[Growi APIの`/page`](https://docs.growi.org/redoc.html#operation/getPage) で取得できるJSONオブジェクトの一部を要素としています。

|要素名|  型 | 意味 |
|----|------|-------|
|path|  str | ページパス |
|id|  str | ページID |
|liker|  int | ライクした人の数 |
|seen|  int | 足跡の数 |
|commentCount|  int | コメント数 |
|authors|  int | 編集者数 |


```python
class Ranks(UserList):
    """Growi記事ランキング"""
    def __init__(self, *args):
        """List of Rank"""
        super().__init__(*args)
```

`Rank` の要素を並べ、ランキングのリストを表現する `Ranks` クラスです。
`UserList`を継承していますので、`append()`, `index()` メソッドを使ってリストのように扱えます。


# エントリーポイント

```python
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("dst", help="Growiのランキング表示先ページパス")
    parser.add_argument("src",
                        nargs="?",
                        default="/",
                        help="Growiのランキング集計元ページパス")
    parser.add_argument("top",
                        nargs="?",
                        type=int,
                        default=10,
                        help="ランキング上位数")
    parser.add_argument("-n",
                        "--dryrun",
                        action="store_true",
                        help="標準出力へマークダウンをprintするのみで、記事投稿しない。")
    args = parser.parse_args()
    main(args.dst, args.src, args.top, dryrun=args.dryrun)
```

引数を解析して `main()` 関数へ渡しています。
`$ python ranking.py DST [SRC] [TOP] `のようにして使います。
`ranking.py`へ渡す引数は DST = ランキングを表示するページパス, SRC = ランキング集計元の親ページパス、 TOP = 上位数を意味します。
SRC, TOPは省略可能です。

`main()`では`ranking_element`の中身を`for`で回して、タイトルとランキングを組み合わせたマークダウン形式の文字列を作ります。

ページ内容(`rank_page.body`) は`page_body`と同じ形式のマークダウン文字列です。
その内容を逆に解析して`Ranks`と比較するページIDのリストを作成します。

更新前のランキングリストを `more_itertools.chunked()`で一定数のリストに分割します。
ここではトップ10のランキングを作りたいので、
タイトル+40行のマークダウンを4x10のリストオブリストに変換しました。

前のランキングがなければ、`try`分岐で`ranks.order()`へ`None`を渡します。
すでにアップされているランキングページの内容を取得します。
前回ランキングと現在ランキングを比較して、前回と比べて順位が上がった、下がったを判定するために使います。


最後にページの内容(`page_body`)を`DST`で指定したページへ投稿し、結果のJSONを`print()`します。


# 使い方

```shell-session
$ python ranking.py DST [SRC] [TOP]
```

DSTを"/Sidebar"にして常に左側のサイドバーにランキングが表示されるようにしました。(スクショなし)
SRCはデフォルトの"/"、TOPはデフォルトの"10"ですので、指定していません。
Dockerコンテナ上で`cron`を使って、毎日定期的にGrowiのランキング集計、投稿を行っています。
[Dockerfile](https://github.com/u1and0/growi_tools/blob/master/Dockerfile)
